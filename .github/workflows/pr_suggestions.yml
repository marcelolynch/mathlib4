name: PR suggestions

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize

# Limit permissions for GITHUB_TOKEN for the entire workflow
permissions:
  contents: read
  pull-requests: write  # Only allow PR comments
  # All other permissions are implicitly 'none'

jobs:
  workflow_docs_reminder:
    if: (github.repository == 'leanprover-community/mathlib4') && (github.event.pull_request.state == 'open')
    runs-on: ubuntu-latest
    steps:
      - name: Detect workflow file changes
        id: changed-workflows
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const workflowFiles = files.filter(file =>
              file.filename.startsWith('.github/workflows/')
            );

            core.setOutput('has_changes', workflowFiles.length > 0 ? 'true' : 'false');
            core.setOutput(
              'files',
              workflowFiles.map(file => `- \`${file.filename}\``).join('\n')
            );

      - name: Add workflow documentation reminder
        if: steps.changed-workflows.outputs.has_changes == 'true'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: 'Workflow Docs Reminder'
          message: |
            ### ðŸ“š Workflow documentation reminder
            This PR modifies files under `.github/workflows/`.
            Please update `docs/workflows.md` if the workflow inventory, triggers, or behavior changed.

            Modified workflow files:
            ${{ steps.changed-workflows.outputs.files }}
